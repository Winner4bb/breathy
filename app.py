from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage, QuickReply, QuickReplyButton, MessageAction
import requests
import os

# ---------------- CONFIG ----------------
CHANNEL_ACCESS_TOKEN = os.getenv("CHANNEL_ACCESS_TOKEN")
CHANNEL_SECRET = os.getenv("CHANNEL_SECRET")
AQICN_API = os.getenv("AQICN_API")

line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)
app = Flask(__name__)

# ---------------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ----------------
def get_aqi(city):
    url = f"https://api.waqi.info/feed/{city}/?token={AQICN_API}"
    try:
        r = requests.get(url).json()
        if r['status'] == 'ok':
            return r['data']['aqi']
    except:
        pass
    return None

def assess_risk(age, smoker, family_history, symptoms, aqi):
    score = 0
    if age < 12 or age > 60:
        score += 1
    if smoker:
        score += 2
    if family_history:
        score += 2
    score += len(symptoms)
    if aqi is not None and aqi > 100:
        score += 2

    if score <= 2:
        level = "‡∏ï‡πà‡∏≥"
        advice = "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
    elif score <= 5:
        level = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
        advice = "‡∏£‡∏∞‡∏ß‡∏±‡∏á ‡∏û‡∏Å‡∏¢‡∏≤ inhaler, ‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å, ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ù‡∏∏‡πà‡∏ô/‡∏Ñ‡∏ß‡∏±‡∏ô"
    else:
        level = "‡∏™‡∏π‡∏á"
        advice = "‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô"
    return level, advice

# ---------------- Normalization Helper ----------------
def normalize_city(text):
    cities = {
        "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û",
        "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û",
        "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà",
        "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà",
        "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï",
        "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï",
        "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô",
        "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô"
    }
    return cities.get(text, None)

def normalize_symptom(text):
    symptoms = {
        "‡πÑ‡∏≠": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÑ‡∏≠",
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÑ‡∏≠": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÑ‡∏≠",
        "‡∏à‡∏≤‡∏°": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏à‡∏≤‡∏°",
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏à‡∏≤‡∏°": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏à‡∏≤‡∏°",
        "‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î",
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î",
        "‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å",
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å",
        "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢",
        "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢"
    }
    return symptoms.get(text, None)

def normalize_family(text):
    if text in ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "family:n"]:
        return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß"
    if text in ["‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "family:y"]:
        return "‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß"
    return None

def normalize_smoker(text):
    if text in ["‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", "smoker:y"]:
        return "‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà"
    if text in ["‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", "smoker:n"]:
        return "‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà"
    return None

# ---------------- Webhook ----------------
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

# ---------------- Event Handler ----------------
user_data = {}  # ‡πÄ‡∏Å‡πá‡∏ö session ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    text = event.message.text.strip().lower()
    user_id = event.source.user_id

    qr_reset = QuickReply(items=[QuickReplyButton(action=MessageAction(label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó", text="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó"))])

    if text == "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó":
        user_data[user_id] = None
        line_bot_api.reply_message(event.reply_token, TextSendMessage(
            text="‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡πÅ‡∏•‡πâ‡∏ß\n‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà"
        ))
        return

    if text.startswith("‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô") or user_id not in user_data or user_data.get(user_id) is None:
        user_data[user_id] = {"step": "age", "age": None, "smoker": None, "family": None, "symptoms": []}
        line_bot_api.reply_message(event.reply_token, TextSendMessage(
            text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç):", quick_reply=qr_reset
        ))
        return

    data = user_data.get(user_id)
    if not data:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", quick_reply=qr_reset))
        return

    step = data.get("step")

    # Step: age
    if step == "age":
        try:
            age = int(text)
            if age <= 0 or age > 120:
                raise ValueError
            data["age"] = age
            data["step"] = "smoker"
            qr_smoker = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", text="‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà")),
                QuickReplyButton(action=MessageAction(label="‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà", text="‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà")),
                QuickReplyButton(action=MessageAction(label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó", text="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó"))
            ])
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏Ñ‡∏∏‡∏ì‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", quick_reply=qr_smoker))
        except:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", quick_reply=qr_reset))
        return

    # Step: smoker
    if step == "smoker":
        norm = normalize_smoker(text)
        if norm == "‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà":
            data["smoker"] = True
        elif norm == "‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà":
            data["smoker"] = False
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(
                text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', 'smoker:y', '‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', 'smoker:n'", quick_reply=qr_reset))
            return
        data["step"] = "family"
        qr_family = QuickReply(items=[
            QuickReplyButton(action=MessageAction(label="‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î", text="‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß")),
            QuickReplyButton(action=MessageAction(label="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", text="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß")),
            QuickReplyButton(action=MessageAction(label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó", text="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó"))
        ])
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", quick_reply=qr_family))
        return

    # Step: family
    if step == "family":
        norm = normalize_family(text)
        if norm == "‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß":
            data["family"] = True
        elif norm == "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß":
            data["family"] = False
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(
                text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß', 'family:y', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß', 'family:n'", quick_reply=qr_reset))
            return
        data["step"] = "symptom"
        symptoms_qr = QuickReply(items=[
            QuickReplyButton(action=MessageAction(label="‡πÑ‡∏≠", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÑ‡∏≠")),
            QuickReplyButton(action=MessageAction(label="‡∏à‡∏≤‡∏°", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏à‡∏≤‡∏°")),
            QuickReplyButton(action=MessageAction(label="‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î")),
            QuickReplyButton(action=MessageAction(label="‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å")),
            QuickReplyButton(action=MessageAction(label="‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢")),
            QuickReplyButton(action=MessageAction(label="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", text="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ")),
            QuickReplyButton(action=MessageAction(label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó", text="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó"))
        ])
        line_bot_api.reply_message(event.reply_token, TextSendMessage(
            text="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏î '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à):", quick_reply=symptoms_qr))
        return

    # Step: symptom
    if step == "symptom":
        norm = normalize_symptom(text)
        if norm:
            symptom = norm.replace("‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:", "")
            if symptom not in data["symptoms"]:
                data["symptoms"].append(symptom)
            symptoms_qr = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="‡πÑ‡∏≠", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÑ‡∏≠")),
                QuickReplyButton(action=MessageAction(label="‡∏à‡∏≤‡∏°", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏à‡∏≤‡∏°")),
                QuickReplyButton(action=MessageAction(label="‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î")),
                QuickReplyButton(action=MessageAction(label="‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å")),
                QuickReplyButton(action=MessageAction(label="‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢", text="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢")),
                QuickReplyButton(action=MessageAction(label="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", text="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ")),
                QuickReplyButton(action=MessageAction(label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó", text="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó"))
            ])
            line_bot_api.reply_message(event.reply_token, TextSendMessage(
                text="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à:", quick_reply=symptoms_qr))
            return
        elif text == "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ":
            if not data["symptoms"]:
                line_bot_api.reply_message(event.reply_token, TextSendMessage(
                    text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á", quick_reply=qr_reset))
                return
            data["step"] = "city"
            city_qr = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û", text="‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û")),
                QuickReplyButton(action=MessageAction(label="‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", text="‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà")),
                QuickReplyButton(action=MessageAction(label="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", text="‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï")),
                QuickReplyButton(action=MessageAction(label="‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", text="‡πÄ‡∏°‡∏∑‡∏≠‡∏á:‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô")),
                QuickReplyButton(action=MessageAction(label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó", text="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó"))
            ])
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ:", quick_reply=city_qr))
            return
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô '‡πÑ‡∏≠', '‡∏à‡∏≤‡∏°', '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏µ‡πâ‡∏î', '‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å', '‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢', ‡∏´‡∏£‡∏∑‡∏≠ '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'", quick_reply=qr_reset))
            return

    # Step: city
    if step == "city":
        norm = normalize_city(text)
        if norm:
            city = norm.replace("‡πÄ‡∏°‡∏∑‡∏≠‡∏á:", "")
            age = data["age"]
            smoker = data["smoker"]
            family_history = data["family"]
            symptoms = data["symptoms"]

            aqi = get_aqi(city)
            level, advice = assess_risk(age, smoker, family_history, symptoms, aqi)

            reply = f"""üìå ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î
‡∏≠‡∏≤‡∏¢‡∏∏: {age}, ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà: {'‡∏™‡∏π‡∏ö' if smoker else '‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö'}, ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß: {'‡∏°‡∏µ' if family_history else '‡πÑ‡∏°‡πà‡∏°‡∏µ'}
‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: {', '.join(symptoms)}

üå´ AQI: {aqi if aqi is not None else '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ'}

‚ö†Ô∏è ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: {level}
üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: {advice}
"""
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply, quick_reply=qr_reset))
            user_data[user_id] = None  # ‡∏•‡πâ‡∏≤‡∏á session
            return
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'", quick_reply=qr_reset))
            return

    # ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£", quick_reply=qr_reset))

# ---------------- RUN ----------------
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
